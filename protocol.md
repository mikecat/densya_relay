電車の橋渡し 通信プロトコル
===========================

## 共通事項

### ベースとなるプロトコル

UDP を用いて通信を行う。

### 連番

連番を用いることで、パケットの順番が入れ替わった際、新しい状態が古い状態で上書きされる可能性を減らす。

連番は、2バイト符号なし整数 (0x0000 ～ 0xffff) を用いる。

送信側・受信側がそれぞれ独立した連番を用いる。

情報を送る際、前回送った連番に 1 を足した連番を用いる。(0xffff + 1 = 0x0000 とする)

受け取った連番が、前回受け取った連番以下、かつ、前回受け取った連番 - 0x4000 以上の場合、順番が入れ替わった古い情報とみなし、無視する。  
この判定は、ラップアラウンドを考慮して行う。(たとえば、前回 0x0010 を受け取っている場合、今回受け取ったのが 0xfff0 なら無視する)  
無視したデータに含まれる連番は、「前回受け取った連番」とみなさない。

### メモ

パケットロスが発生しても、状態の不整合 (特に、離したはずのキーが離されない) がなるべく起きないようにする。

状態が変化した際に、メッセージを送信する。  
また、パケットロスによる害の軽減、および通信状態の確認のため、状態が変化していなくても約1秒おきにメッセージを送信する。

将来メッセージの暗号化の仕様を追加する際は、最初の1バイトを「暗号化されたメッセージ」を表す値にする。  
具体的な値、およびその後のデータの内容は、暗号化の仕様を決める際に考える。

## メッセージ

### 送信データの送信

変換器側から送られる情報 (キー操作の情報を含む) をゲーム側に伝える。

以下のデータを順に結合する。

1. 0x00 (メッセージの種類を表す) 1バイト
2. 連番 2バイト ビッグエンディアン
3. 送信データのバイト数 1バイト
4. 送信データ 指定したバイト数
5. 押されているキーデータの要素数 1バイト
6. 押されているキーデータ 指定した要素数×3バイト

押されているキーデータの1要素は、以下のデータを順に結合する。

1. 押されたキーの仮想キーコード 1バイト
2. 押されたキーのスキャンコード 1バイト
3. フラグ 1バイト

フラグの最下位ビットは、キーが拡張キーであるかを表す。(0：拡張キーでない、1：拡張キーである)  
フラグのその他のビットは予約。(無視する)

### 受信データの送信

ゲーム側から送られる情報を変換器側に伝える。

以下のデータを順に結合する。

1. 0x01 (メッセージの種類を表す) 1バイト
2. 連番 2バイト ビッグエンディアン
3. 受信データのバイト数 1バイト
4. 受信データ 指定したバイト数
